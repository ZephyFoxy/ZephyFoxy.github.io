---
published: false
title: Malware Analysis - Wannacry
tags:
  - Malware Analysis
---

-----
# Intro
-----

It was the middle of May 2017. I was working night shift in a datacenter on the Windows server team. My desk phone rings and it's a security analyst working for one of the datacenter's tenants, asking us to immediately apply patches to all their servers for the EternalBlue vulnerability because of the WannaCry outbreak. I explain that we already have arrangements in place and that we don't just hurl patches onto servers without vetting them first.

As the night goes on I start keeping tabs on the outbreak, reading news articles, looking at the non-stop flow of new information on social media. In particular, I saw lots of posts on Twitter from malware analysts, with lots of screenshots of debuggers, disassemblers, and other things that at the time, I didn't really recognize. At this point in time I had barely even really started Pentesting With Kali linux and such things were beyond me. But for some reason, on this night in particular, probably due to the sheer size of the outbreak, these Twitter posts piqued my curiosity more than normal. I was astounded by how these people could point out which bits of disassembled code did what. Those posts made me want to learn to reverse engineer malware.

Fast forward about three and a half years and I find myself enrolled in eLearnSecurity's "Malware Analysis Professional" course. I had shown some mild interest in the course a couple of months prior, but what finally pushed me to enroll was a tiny bit of information I learned from someone in the course; one of the labs walks you through analyzing WannaCry.

I took it as a sign, and enrolled.

Many many people have discussed WannaCry's internal workings since the initial outbreak. Blogs, youtube videos, you name it. 

My analysis will not uncover anything new, or reveal hidden secrets. But I enjoyed ripping this apart so much that I feel like I have to share anyway.

-----
# Static Analysis With PeStudio
-----

The first step I take in approaching any unknown, untrusted, or malicious program is to load it up into `PeStudio`, a static malware-analysis tool made by Winitor.
From here I can derive some basic information about the executable, and form some early opinions on what the malware may be doing.

![]({{site.baseurl}}/assets/images/wannacry/1.png)

From this first look at the malware, we get some preliminary details such as the hashes, the `magic bytes`, level of `entropy`, the complier signature, and more.

The description is a little weird, it's calling itself `Microsoft Disk Defragmenter`. Possibly a lazy attempt at avoiding raising suspicion. I found out later that this string is what gets displayed if you look at the process in Task Manager.

I move to the `Resources` tab in PeStudio and see something unusual:

![]({{site.baseurl}}/assets/images/wannacry/2.png)

There is a resource named `R`, which isn't normal, and PeStudio is flagging it as an executable. The `entropy` is also very high at 7.995. 

In files, entropy refers to the degree of "randomness", for lack of a better word. If the entropy is high, it indicates potential attempts at obfuscating the malware. "Packed", encrypted, or "zipped" files within malware also have very high entropy.

While combing through the "Strings" tab in PeStudio, I find the infamous URL:

![]({{site.baseurl}}/assets/images/wannacry/3.png)

This is the URL discovered by malware researcher Marcus Hutchins, which was later discovered to be the "kill switch" when he registered the domain and noticed that the outbreak began to shut down.

Continuing through the strings, I see this:

![]({{site.baseurl}}/assets/images/wannacry/4.png)

This indicates that this malware may be employing code that has been zipped and comes with a built-in unzipper.

Pushing deeper into the mess of strings, I find some questionable strings that look like commands:

![]({{site.baseurl}}/assets/images/wannacry/5.png)

There's some references to cmd.exe, icacls to change permissions on something, and tasksche.exe, indicating either a timed task or maybe some form of persistence.

My analysis then moved on to look at some of the DLLs being loaded by the malware, and the API calls being made to those DLLs:

![]({{site.baseurl}}/assets/images/wannacry/6.png)

![]({{site.baseurl}}/assets/images/wannacry/7.png)

PeStudio marks suspicious activity with red `x`'s. This doesn't necessarily mean it's malicious, rather, it draws your attention to it to indicate that further analysis should be caried out.
In this case we see some questionable calls to some networking functions, as well as some cryptographic functions towards the bottom of the "Imports" page.

-----
# Dynamic Analysis with x64Debug
-----
`x64Dbg` is a Windows debugger that supports both x86 and x64, and has a familiar interface that should be easy to learn for anyone who has used Immunity Debugger. x64Dbg has some features that Immunity either doesn't have, or it improves upon. It's useful for analyzing malware.

I load wannacry into x64Dbg and examine the primary executable. Inside, I see the kill-switch URL being loaded into a register, likely being passed as argument to the following API call to `InternetOpenUrlA`:

![]({{site.baseurl}}/assets/images/wannacry/9.png)

`InternetOpenUrlA` will return a handle and store it in EAX if the request to the URL was successful.

Immediately below the call to the API, we see `mov edi, eax`. This will move the handle ID into EDI, which is used a few instructions down at the `test edi, edi`. This will perform a bit-wise `AND` against the two arguments, which in this case, is just EDI being `AND`'d against itself. 

If the result of the `test` operation is 0, the ZF flag is set to 1. </br>
If the result of the `test` operation is anything but 0, the ZF flag is set to 0.

In the case of the connection to the URL **failing**, the `test` will produce a 0. [Microsoft's documentation](https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopenurla) on `InternetOpenUrlA` says that if the attempt to connect to the provided URL fails, the API returns NULL.

![](https://i.imgur.com/VxC3qR7.png)

This means that if the connection succeeds, we should have something other than a 0 in EDI, so the test will set the ZF flag to 0.

Just below the test we see `jne wannacry.4081BC`. This is a *conditional jump* that will occur if the result of the previous operation is NOT equal. To determine this, the instruction evaluates the ZF flag. If the ZF flag is set to 1, the last operation was `equal`, and the jump is **not** made. If the ZF flag is 0, then the last operation was `not equal`, and the jump is taken. This instruction will jump to code located at address `0x4081BC` if the ZF flag is 1. We can assume that this is the code that terminates the malware if the kill-switch domain is live and the victim machine has an active internet connection that successfully resolves the domain.

This action takes place not far from the `entry point` of the malware, meaning that the kill-switch will trigger before it does *anything*.

I set a breakpoint at the call to `InternetOpenUrlA` and then `stepped over` the call and examined EAX:

![]({{site.baseurl}}/assets/images/wannacry/11.png)

EAX is a non-zero value. That is because I deliberately did this analysis on a VM that had an internet connection, because I wanted to see this kill-switch in action.

If we step thru down to the `jne` instruction, x64Dbg kindly highlights that the jump is taken and shows us where the jump goes:

![]({{site.baseurl}}/assets/images/wannacry/12.png)

I follow this code for a little while and then find this:

![]({{site.baseurl}}/assets/images/wannacry/13.png)

This validates that the kill-switch has worked as intended and directed the program to exit without doing anything further.

-----
# Pivoting back to static analysis
-----

When doing malware analysis you may find yourself going back and forth between static and dynamic analysis techniques, and it seems to be the natural flow of things.

Recall that earlier we saw that there was a "resource" named `R` in this binary with high entropy, and that this binary made a vague reference to unzipping software.

Using a tool called `Resource Hacker`, we can view, and even extract this "resource".

During this analysis, we see that this resource is an executable:

![]({{site.baseurl}}/assets/images/wannacry/14.png)
